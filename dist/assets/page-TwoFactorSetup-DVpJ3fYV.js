import{u as v,r as d,j as a}from"./vendor-B8znzfp2.js";import{d as j,A as y,L as E,I as T,u as f}from"./page-Login-C96z17Ba.js";import{B as F,s as A}from"./page-About-Cx_WpGeO.js";const N="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";function x(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}async function k(e,t){const s=await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-1"},!1,["sign"]),r=await crypto.subtle.sign("HMAC",s,t);return new Uint8Array(r)}function D(e=20){const t=x(e);let s="";for(let r=0;r<t.length;r++)s+=N[t[r]%N.length];return s}function C(e){let t="";const s=e.replace(/=+$/g,"").toUpperCase();for(const o of s){const c=N.indexOf(o);c!==-1&&(t+=c.toString(2).padStart(5,"0"))}const r=[];for(let o=0;o+8<=t.length;o+=8)r.push(parseInt(t.substring(o,o+8),2));return new Uint8Array(r)}function b(e,t,s){e[s]=t>>>24&255,e[s+1]=t>>>16&255,e[s+2]=t>>>8&255,e[s+3]=t&255}function V(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}async function U(e,t=30,s=6,r=Date.now()){const o=C(e),c=Math.floor(r/1e3/t),n=new Uint8Array(8);b(n,Math.floor(c/4294967296),0),b(n,c%4294967296,4);const i=await k(o,n),l=i[i.length-1]&15;return((V(i,l)&2147483647)%10**s).toString().padStart(s,"0")}async function I(e,t,s=1,r=30,o=6){const c=Date.now();for(let n=-s;n<=s;n++){const i=c+n*r*1e3;if(await U(t,r,o,i)===e)return!0}return!1}function B(){const e=x(4);return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("").toUpperCase()}function R(e,t,s){return`otpauth://totp/${encodeURIComponent(t)}:${encodeURIComponent(e)}?secret=${s}&issuer=${encodeURIComponent(t)}`}const O=()=>{const{profile:e}=j(),t=v(),[s,r]=d.useState(""),[o,c]=d.useState(""),[n,i]=d.useState(""),[l,g]=d.useState(""),[w,p]=d.useState(!1);d.useEffect(()=>{if(e){const u=D();r(u);const m=B();c(m);const S=R(e.email,"AssistJur",u);i(`https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(S)}`)}},[e]);const h=async()=>{if(e){p(!0);try{if(!await I(l,s)){f.error("Código inválido"),p(!1);return}const{error:m}=await A.from("profiles").update({updated_at:new Date().toISOString()}).eq("id",e.id);if(m)throw m;sessionStorage.setItem("mfa_verified","true"),f.success("2FA habilitado"),t("/dados/mapa")}catch(u){console.error("Enable 2FA error:",u),f.error("Erro ao habilitar 2FA")}finally{p(!1)}}};return e?a.jsxDEV("div",{className:"min-h-screen bg-gradient-subtle flex flex-col justify-center px-6 py-12",children:a.jsxDEV("div",{className:"mx-auto w-full max-w-md",children:a.jsxDEV(y,{title:"Ativar verificação em duas etapas",description:"Use um aplicativo autenticador",children:a.jsxDEV("div",{className:"space-y-4",children:[n&&a.jsxDEV("img",{src:n,alt:"QR code",className:"mx-auto"},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:79,columnNumber:23},void 0),a.jsxDEV("div",{className:"text-sm text-center",children:a.jsxDEV("p",{children:["Escaneie o QR code ou use o código:",a.jsxDEV("code",{className:"font-mono ml-1",children:s},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:83,columnNumber:17},void 0)]},void 0,!0,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:81,columnNumber:15},void 0)},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:80,columnNumber:13},void 0),a.jsxDEV("div",{className:"text-sm text-center",children:a.jsxDEV("p",{children:["Guarde seu código de backup:",a.jsxDEV("code",{className:"font-mono ml-1",children:o},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:89,columnNumber:17},void 0)]},void 0,!0,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:87,columnNumber:15},void 0)},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:86,columnNumber:13},void 0),a.jsxDEV("div",{className:"space-y-2",children:[a.jsxDEV(E,{htmlFor:"code",children:"Código do aplicativo"},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:93,columnNumber:15},void 0),a.jsxDEV(T,{id:"code",value:l,onChange:u=>g(u.target.value.replace(/\D/g,"").slice(0,6)),placeholder:"000000",autoComplete:"one-time-code"},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:94,columnNumber:15},void 0)]},void 0,!0,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:92,columnNumber:13},void 0),a.jsxDEV(F,{className:"w-full",onClick:h,disabled:w||l.length!==6,children:w?"Verificando...":"Ativar 2FA"},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:104,columnNumber:13},void 0)]},void 0,!0,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:78,columnNumber:11},void 0)},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:74,columnNumber:9},void 0)},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:73,columnNumber:7},void 0)},void 0,!1,{fileName:"/workspaces/assitjur/src/pages/TwoFactorSetup.tsx",lineNumber:72,columnNumber:5},void 0):null},_=Object.freeze(Object.defineProperty({__proto__:null,default:O},Symbol.toStringTag,{value:"Module"}));export{_ as T,I as v};
