import{u as A,r as u,j as r}from"./vendor-DjGBFEeb.js";import{e as j,A as C,L as b,I as U,u as h}from"./page-Login-BicjLTnC.js";import{B as N,s as E}from"./page-About-C9AEn_cr.js";const g="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";function S(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}async function I(e,t){const n=await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-1"},!1,["sign"]),a=await crypto.subtle.sign("HMAC",n,t);return new Uint8Array(a)}function T(e=20){const t=S(e);let n="";for(let a=0;a<t.length;a++)n+=g[t[a]%g.length];return n}function B(e){let t="";const n=e.replace(/=+$/g,"").toUpperCase();for(const o of n){const c=g.indexOf(o);c!==-1&&(t+=c.toString(2).padStart(5,"0"))}const a=[];for(let o=0;o+8<=t.length;o+=8)a.push(parseInt(t.substring(o,o+8),2));return new Uint8Array(a)}function y(e,t,n){e[n]=t>>>24&255,e[n+1]=t>>>16&255,e[n+2]=t>>>8&255,e[n+3]=t&255}function R(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}async function F(e,t=30,n=6,a=Date.now()){const o=B(e),c=Math.floor(a/1e3/t),s=new Uint8Array(8);y(s,Math.floor(c/4294967296),0),y(s,c%4294967296,4);const i=await I(o,s),d=i[i.length-1]&15;return((R(i,d)&2147483647)%10**n).toString().padStart(n,"0")}async function O(e,t,n=1,a=30,o=6){const c=Date.now();for(let s=-n;s<=n;s++){const i=c+s*a*1e3;if(await F(t,a,o,i)===e)return!0}return!1}function $(){const e=S(4);return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("").toUpperCase()}function k(e,t,n){return`otpauth://totp/${encodeURIComponent(t)}:${encodeURIComponent(e)}?secret=${n}&issuer=${encodeURIComponent(t)}`}const L=()=>{const{profile:e}=j(),t=A(),[n,a]=u.useState(""),[o,c]=u.useState(""),[s,i]=u.useState(""),[d,f]=u.useState(""),[x,m]=u.useState(!1);u.useEffect(()=>{if(e){const l=T();a(l);const p=$();c(p);const w=k(e.email,"AssistJur",l);i(`https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(w)}`)}},[e]);const v=async()=>{if(e){m(!0);try{if(!await O(d,n)){h.error("Código inválido"),m(!1);return}const{error:p}=await E.from("profiles").update({updated_at:new Date().toISOString()}).eq("id",e.id);if(p)throw p;sessionStorage.setItem("mfa_verified","true"),h.success("2FA habilitado"),t("/dados/mapa")}catch(l){console.error("Enable 2FA error:",l),h.error("Erro ao habilitar 2FA")}finally{m(!1)}}};return e?r.jsx("div",{className:"min-h-screen bg-gradient-subtle flex flex-col justify-center px-6 py-12",children:r.jsx("div",{className:"mx-auto w-full max-w-md",children:r.jsx(C,{title:"Ativar verificação em duas etapas",description:"Use um aplicativo autenticador",children:r.jsxs("div",{className:"space-y-4",children:[s&&r.jsx("img",{src:s,alt:"QR code",className:"mx-auto"}),r.jsx("div",{className:"text-sm text-center",children:r.jsxs("p",{children:["Escaneie o QR code ou use o código:",r.jsx("code",{className:"font-mono ml-1",children:n})]})}),r.jsx("div",{className:"text-sm text-center",children:r.jsxs("p",{children:["Guarde seu código de backup:",r.jsx("code",{className:"font-mono ml-1",children:o})]})}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(b,{htmlFor:"code",children:"Código do aplicativo"}),r.jsx(U,{id:"code",value:d,onChange:l=>f(l.target.value.replace(/\D/g,"").slice(0,6)),placeholder:"000000",autoComplete:"one-time-code"})]}),r.jsx(N,{className:"w-full",onClick:v,disabled:x||d.length!==6,children:x?"Verificando...":"Ativar 2FA"})]})})})}):null},H=Object.freeze(Object.defineProperty({__proto__:null,default:L},Symbol.toStringTag,{value:"Module"}));export{H as T,O as v};
