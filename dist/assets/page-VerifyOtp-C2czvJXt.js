import{r as m,y as N,j as e,cm as h,L as b,N as y,a0 as x,u as w,ag as C}from"./vendor-cb6Vd3Sa.js";import{L as S,I as V,u as _,e as T,f as F,A}from"./page-Login-DHksUS7l.js";import{r as E,u as I,B as g,w as L}from"./page-About-BgklZ4WV.js";import{v as k}from"./page-TwoFactorSetup-C-o9qBj0.js";const B=I({code:L().length(6,"Código deve ter 6 dígitos").regex(/^\d{6}$/,"Código deve conter apenas números")}),U=({onBack:o,onSuccess:u,userEmail:i,secret:s,backupCode:f})=>{const[d,t]=m.useState(!1),[l,p]=m.useState(0),a=N({resolver:E(B),defaultValues:{code:""}}),c=async n=>{t(!0);try{await k(n.code,s)||f&&n.code===f?(x.success("Verificação concluída!",{description:"Acesso autorizado com sucesso."}),u()):(p(j=>j+1),l>=2?(x.error("Muitas tentativas",{description:"Conta temporariamente bloqueada. Tente novamente em 15 minutos."}),o()):(x.error("Código inválido",{description:`Código incorreto. Tentativas restantes: ${3-l-1}`}),a.reset()))}catch(r){console.error("2FA verification error:",r),x.error("Erro na verificação",{description:"Não foi possível verificar o código. Tente novamente."})}finally{t(!1)}},v=n=>{const r=n.replace(/\D/g,"").slice(0,6);return r.length<=3?r:`${r.slice(0,3)} ${r.slice(3)}`};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"mx-auto p-3 bg-primary/10 rounded-full w-fit",children:e.jsx(h,{className:"h-6 w-6 text-primary"})}),e.jsx("h3",{className:"text-lg font-semibold",children:"Verificação em duas etapas"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Digite o código de 6 dígitos do seu aplicativo autenticador"}),i&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Entrando como: ",e.jsx("strong",{children:i})]})]}),e.jsxs("form",{onSubmit:a.handleSubmit(c),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(S,{htmlFor:"code",children:"Código de verificação"}),e.jsx(V,{id:"code",placeholder:"000 000",...a.register("code"),onChange:n=>{const r=v(n.target.value);a.setValue("code",r.replace(" ","")),n.target.value=r},className:`text-center text-2xl font-mono tracking-widest ${a.formState.errors.code?"border-destructive":""}`,maxLength:7,autoFocus:!0,autoComplete:"one-time-code"}),a.formState.errors.code&&e.jsx("p",{className:"text-sm text-destructive",children:a.formState.errors.code.message})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(g,{type:"submit",className:"w-full",disabled:d||a.watch("code").length!==6,children:d?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-4 w-4 animate-spin mr-2"}),"Verificando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(h,{className:"h-4 w-4 mr-2"}),"Verificar código"]})}),e.jsx("div",{className:"flex justify-center",children:e.jsxs(g,{type:"button",variant:"ghost",onClick:o,disabled:d,className:"text-xs",children:[e.jsx(y,{className:"h-3 w-3 mr-1"}),"Voltar"]})})]})]}),e.jsx("div",{className:"text-center text-xs text-muted-foreground",children:e.jsx("p",{children:"Não consegue acessar seu autenticador? Utilize o código de backup fornecido ao habilitar o 2FA."})})]})},D=()=>{const o=w(),[u]=C(),{user:i,profile:s}=_(),[f,d]=m.useState(""),t=u.get("next"),l=u.get("email");m.useEffect(()=>{if(i&&s&&!s.two_factor_enabled){const c=t?decodeURIComponent(t):"/dados/mapa";o(c)}},[i,s,o,t]),m.useEffect(()=>{l?d(l):i?.email&&d(i.email)},[l,i]),m.useEffect(()=>{if(s&&!s.two_factor_enabled){const c=t?decodeURIComponent(t):"/dados/mapa";o(c)}},[s,o,t]);const p=()=>{sessionStorage.setItem("mfa_verified","true");const c=t?decodeURIComponent(t):"/dados/mapa";o(c)},a=()=>{o("/login")};return!s?.two_factor_enabled||!s.two_factor_secret?null:e.jsx("div",{className:"min-h-screen bg-gradient-subtle flex flex-col justify-center px-6 py-12",children:e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[e.jsx("div",{className:"flex items-center justify-center mb-8",children:e.jsx(T,{size:"lg",className:"gap-3"})}),e.jsx("div",{className:"mb-6",children:e.jsx(F,{variant:"info",title:"Verificação adicional necessária",children:"Sua conta possui verificação em duas etapas ativada para maior segurança."})}),e.jsx(A,{title:"Verificação em duas etapas",description:"Confirme sua identidade para continuar",children:e.jsx(U,{onBack:a,onSuccess:p,userEmail:f,secret:s.two_factor_secret,backupCode:s.two_factor_backup_code??void 0})}),e.jsx("div",{className:"mt-8 text-center",children:e.jsx("p",{className:"text-xs text-muted-foreground",children:"Esta verificação adicional protege sua conta e dados sensíveis."})})]})})};export{D as default};
